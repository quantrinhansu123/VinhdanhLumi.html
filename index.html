<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao diện Tổng - LUMI</title>
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #display-frame {
            width: 100%;
            flex: 1;
            border: none;
            display: block;
        }

        /* Thanh điều hướng */
        .navigation-bar {
            background: linear-gradient(90deg, #66cc44 0%, #4a9928 25%, #2d7016 50%, #1a5c0e 75%, #0d3d07 100%);
                padding: 8px 16px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 10px rgba(13, 61, 7, 0.5), 0 -4px 20px rgba(102, 204, 68, 0.3);
            z-index: 1000;
        }

        .nav-btn {
            padding: 16px 36px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
                font-size: 15px;
            transition: all 0.3s ease;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
        }

    </style>
</head>

<body>
    <iframe id="display-frame" src="./Thẻ cảnh báo.html"></iframe>

    <div class="navigation-bar" id="navigation-bar"></div>

    <script>
        // Danh sách các tab theo thứ tự
        const tabs = [
            {
                name: 'Cảnh Báo',
                file: './Thẻ cảnh báo.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'BXH top 3',
                file: './BXH top 3.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'BXH Top 3 tháng',
                file: './BXH top 3 tháng.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'Vinh danh top 3',
                file: './Vinh danh top 3.html?mode=slideshow',
                duration: null // Tự động - sẽ tính toán dựa trên số người
            },
            {
                name: 'BXH toàn Team',
                file: './danh sách toàn team.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            }
        ];

        let currentTabIndex = 0;
        let tabTimer = null;
        let soundPlayer = null; // YouTube player để phát âm thanh
        let soundPlayCount = 0; // Đếm số lần đã phát
        let soundPlayTimer = null; // Timer để phát tuần tự

        // Hàm callback khi YouTube API sẵn sàng
        function onYouTubeIframeAPIReady() {
            console.log('[SOUND] YouTube API đã sẵn sàng');
            initSoundPlayer();
        }

        // Khởi tạo sound player
        function initSoundPlayer() {
            if (soundPlayer) return; // Đã khởi tạo rồi

            const playerId = 'tab-sound-player';
            let container = document.getElementById(playerId);
            if (!container) {
                container = document.createElement('div');
                container.id = playerId;
                container.style.display = 'none';
                document.body.appendChild(container);
            }

            try {
                soundPlayer = new YT.Player(playerId, {
                    height: '1',
                    width: '1',
                    videoId: 'EuLJv2qONRY',
                    playerVars: {
                        'autoplay': 0,
                        'loop': 0,
                        'controls': 0,
                        'showinfo': 0,
                        'rel': 0,
                        'modestbranding': 1,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': function (event) {
                            event.target.setVolume(100);
                            console.log('[SOUND] Player đã sẵn sàng');
                        },
                        'onStateChange': function (event) {
                            // Khi video kết thúc, phát lần tiếp theo nếu còn
                            if (event.data === YT.PlayerState.ENDED) {
                                soundPlayCount++;
                                if (soundPlayCount < 4) {
                                    // Phát lần tiếp theo sau 200ms
                                    setTimeout(() => {
                                        try {
                                            event.target.playVideo();
                                        } catch (e) {
                                            console.error('[SOUND] Lỗi phát lần tiếp theo:', e);
                                        }
                                    }, 200);
                                } else {
                                    // Đã phát đủ 4 lần
                                    soundPlayCount = 0;
                                    console.log('[SOUND] Đã phát đủ 4 lần');
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('[SOUND] Lỗi khởi tạo player:', e);
            }
        }

        // Hàm phát âm thanh 4 lần khi chuyển tab
        function playTabSwitchSound() {
            // Đảm bảo player đã sẵn sàng
            if (!soundPlayer) {
                if (typeof YT !== 'undefined' && YT.Player) {
                    initSoundPlayer();
                    // Đợi player khởi tạo xong
                    setTimeout(() => {
                        if (soundPlayer) {
                            startPlayingSound();
                        }
                    }, 500);
                    return;
                } else {
                    console.warn('[SOUND] YouTube API chưa sẵn sàng');
                    return;
                }
            }

            startPlayingSound();
        }

        // Hàm bắt đầu phát âm thanh
        function startPlayingSound() {
            if (!soundPlayer) return;

            console.log('[SOUND] Bắt đầu phát âm thanh chuyển tab 4 lần');

            // Reset counter và dừng video hiện tại nếu đang phát
            try {
                soundPlayCount = 0;
                // Kiểm tra xem player có sẵn phương thức stopVideo không
                if (soundPlayer.stopVideo && typeof soundPlayer.stopVideo === 'function') {
                    soundPlayer.stopVideo();
                }
                // Đợi một chút rồi bắt đầu phát
                setTimeout(() => {
                    if (soundPlayer.seekTo && typeof soundPlayer.seekTo === 'function') {
                        soundPlayer.seekTo(0, true); // Quay về đầu video
                    }
                    if (soundPlayer.playVideo && typeof soundPlayer.playVideo === 'function') {
                        soundPlayer.playVideo(); // Bắt đầu phát lần đầu
                    }
                }, 100);
            } catch (e) {
                console.error('[SOUND] Lỗi phát âm thanh:', e);
            }
        }

        // Tạo thanh điều hướng
        function createNavigationBar() {
            const navBar = document.getElementById('navigation-bar');
            navBar.innerHTML = '';

            tabs.forEach((tab, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = tab.name;
                btn.onclick = () => loadTab(index);
                navBar.appendChild(btn);
            });

            updateNavigationButtons();
        }

        // Cập nhật trạng thái các nút
        function updateNavigationButtons() {
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach((btn, index) => {
                if (index === currentTabIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function loadTab(index) {
            if (index < 0 || index >= tabs.length) {
                index = 0; // Quay về tab đầu tiên
            }
            currentTabIndex = index;

            const tab = tabs[currentTabIndex];
            const frame = document.getElementById('display-frame');

            console.log(`[TAB SWITCH] Đang chuyển sang: ${tab.name}`);

            // Phát âm thanh chuyển tab 4 lần
            if (typeof YT !== 'undefined' && YT.Player) {
                playTabSwitchSound();
            } else {
                // Nếu API chưa sẵn sàng, đợi một chút rồi thử lại
                setTimeout(() => {
                    if (typeof YT !== 'undefined' && YT.Player) {
                        playTabSwitchSound();
                    }
                }, 500);
            }

            frame.src = tab.file;

            // Cập nhật trạng thái nút
            updateNavigationButtons();

            // Xóa timer cũ nếu có
            if (tabTimer) {
                clearTimeout(tabTimer);
            }

            // Tính thời gian cho tab hiện tại
            let duration = tab.duration;

            // Nếu là "Vinh danh top 3", tính toán thời gian dựa trên số người
            if (tab.name === 'Vinh danh top 3' && duration === null) {
                try {
                    const honorsDataStr = localStorage.getItem('vinhDanhTop3');
                    if (honorsDataStr) {
                        const honorsData = JSON.parse(honorsDataStr);
                        const numPeople = honorsData.length || 6; // Mặc định 6 người (3 Sale + 3 MKT)
                        duration = numPeople * 30000; // Mỗi người 30 giây
                        console.log(`[VINH DANH] Có ${numPeople} người, thời gian: ${duration / 1000} giây`);
                    } else {
                        duration = 180000; // Mặc định 3 phút (6 người * 30s) nếu không có data
                    }
                } catch (e) {
                    console.error('Lỗi đọc dữ liệu vinh danh:', e);
                    duration = 180000; // Mặc định 3 phút
                }
            }

            // Đặt timer để chuyển sang tab tiếp theo
            if (duration) {
                tabTimer = setTimeout(() => {
                    loadTab(currentTabIndex + 1);
                }, duration);
                console.log(`[TIMER] Tab "${tab.name}" sẽ chuyển sau ${duration / 1000} giây (${duration / 60000} phút)`);
            }
        }


        // Khởi động
        createNavigationBar();

        // Tự động load "BXH top 3.html" một lần khi khởi động để tính toán dữ liệu ban đầu
        function initializeBXHTop3() {
            const bxhTop3TabIndex = tabs.findIndex(tab => tab.name === 'BXH top 3');
            if (bxhTop3TabIndex !== -1) {
                console.log('[INIT] Đang load BXH top 3 để tính toán dữ liệu ban đầu...');
                const hiddenFrame = document.createElement('iframe');
                hiddenFrame.style.position = 'absolute';
                hiddenFrame.style.left = '-9999px';
                hiddenFrame.style.width = '1px';
                hiddenFrame.style.height = '1px';
                hiddenFrame.src = tabs[bxhTop3TabIndex].file;
                hiddenFrame.onload = function() {
                    console.log('[INIT] BXH top 3 đã load xong, dữ liệu sẽ được tính toán và lưu vào localStorage');
                    // Xóa iframe sau 5 giây
                    setTimeout(() => {
                        if (hiddenFrame.parentNode) {
                            hiddenFrame.parentNode.removeChild(hiddenFrame);
                        }
                    }, 5000);
                };
                document.body.appendChild(hiddenFrame);
            }
        }

        // Gọi sau khi DOM đã load xong
        setTimeout(() => {
            initializeBXHTop3();
        }, 1000);

        // Khởi tạo sound player nếu YouTube API đã sẵn sàng
        if (typeof YT !== 'undefined' && YT.Player) {
            initSoundPlayer();
        } else {
            // Đợi YouTube API load
            let checkAPI = setInterval(() => {
                if (typeof YT !== 'undefined' && YT.Player) {
                    initSoundPlayer();
                    clearInterval(checkAPI);
                }
            }, 100);
            // Timeout sau 5 giây
            setTimeout(() => clearInterval(checkAPI), 5000);
        }

        loadTab(0);

        // Xử lý lỗi iframe
        document.getElementById('display-frame').addEventListener('error', function (e) {
            console.error('Lỗi load iframe:', e);
            // Thử chuyển sang tab tiếp theo nếu có lỗi
            setTimeout(() => {
                loadTab(currentTabIndex + 1);
            }, 5000);
        });
    </script>
</body>

</html>