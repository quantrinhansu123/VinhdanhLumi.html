<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao diện Tổng - LUMI</title>
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #display-frame {
            width: 100%;
            flex: 1;
            border: none;
            display: block;
        }

        /* Thanh điều hướng */
        .navigation-bar {
            background: linear-gradient(135deg, #44aa22 0%, #66cc44 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 -2px 10px rgba(68, 170, 34, 0.3);
            z-index: 1000;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
        }

        /* Bộ lọc */
        .filter-bar {
            background: linear-gradient(135deg, #44aa22 0%, #66cc44 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(68, 170, 34, 0.3);
            z-index: 1000;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            outline: none;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .filter-select:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filter-select option {
            background: #667eea;
            color: white;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="filter-bar" id="filter-bar"></div>
    <iframe id="display-frame" src="./Thẻ cảnh báo.html"></iframe>
    
    <div class="navigation-bar" id="navigation-bar"></div>

    <script>
        // Danh sách các tab theo thứ tự
        const tabs = [
            {
                name: 'Cảnh Báo',
                file: './Thẻ cảnh báo.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'BXH top 3',
                file: './BXH top 3.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'BXH Top 3 tháng',
                file: './BXH top 3.html?mode=month',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            },
            {
                name: 'Vinh danh top 3',
                file: './Vinh danh top 3.html?mode=slideshow',
                duration: null // Tự động - sẽ tính toán dựa trên số người
            },
            {
                name: 'BXH toàn Team',
                file: './danh sách toàn team.html',
                duration: 600000 // 10 phút = 600 giây = 600000ms
            }
        ];

        let currentTabIndex = 0;
        let tabTimer = null;
        let soundPlayer = null; // YouTube player để phát âm thanh
        let soundPlayCount = 0; // Đếm số lần đã phát
        let soundPlayTimer = null; // Timer để phát tuần tự

        // Hàm callback khi YouTube API sẵn sàng
        function onYouTubeIframeAPIReady() {
            console.log('[SOUND] YouTube API đã sẵn sàng');
            initSoundPlayer();
        }

        // Khởi tạo sound player
        function initSoundPlayer() {
            if (soundPlayer) return; // Đã khởi tạo rồi
            
            const playerId = 'tab-sound-player';
            let container = document.getElementById(playerId);
            if (!container) {
                container = document.createElement('div');
                container.id = playerId;
                container.style.display = 'none';
                document.body.appendChild(container);
            }
            
            try {
                soundPlayer = new YT.Player(playerId, {
                    height: '1',
                    width: '1',
                    videoId: '-G2IBw8hNzs',
                    playerVars: {
                        'autoplay': 0,
                        'loop': 0,
                        'controls': 0,
                        'showinfo': 0,
                        'rel': 0,
                        'modestbranding': 1,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': function(event) {
                            event.target.setVolume(100);
                            console.log('[SOUND] Player đã sẵn sàng');
                        },
                        'onStateChange': function(event) {
                            // Khi video kết thúc, phát lần tiếp theo nếu còn
                            if (event.data === YT.PlayerState.ENDED) {
                                soundPlayCount++;
                                if (soundPlayCount < 4) {
                                    // Phát lần tiếp theo sau 200ms
                                    setTimeout(() => {
                                        try {
                                            event.target.playVideo();
                                        } catch (e) {
                                            console.error('[SOUND] Lỗi phát lần tiếp theo:', e);
                                        }
                                    }, 200);
                                } else {
                                    // Đã phát đủ 4 lần
                                    soundPlayCount = 0;
                                    console.log('[SOUND] Đã phát đủ 4 lần');
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('[SOUND] Lỗi khởi tạo player:', e);
            }
        }

        // Hàm phát âm thanh 4 lần khi chuyển tab
        function playTabSwitchSound() {
            // Đảm bảo player đã sẵn sàng
            if (!soundPlayer) {
                if (typeof YT !== 'undefined' && YT.Player) {
                    initSoundPlayer();
                    // Đợi player khởi tạo xong
                    setTimeout(() => {
                        if (soundPlayer) {
                            startPlayingSound();
                        }
                    }, 500);
                    return;
                } else {
                    console.warn('[SOUND] YouTube API chưa sẵn sàng');
                    return;
                }
            }
            
            startPlayingSound();
        }

        // Hàm bắt đầu phát âm thanh
        function startPlayingSound() {
            if (!soundPlayer) return;
            
            console.log('[SOUND] Bắt đầu phát âm thanh chuyển tab 4 lần');
            
            // Reset counter và dừng video hiện tại nếu đang phát
            try {
                soundPlayCount = 0;
                soundPlayer.stopVideo();
                // Đợi một chút rồi bắt đầu phát
                setTimeout(() => {
                    soundPlayer.seekTo(0, true); // Quay về đầu video
                    soundPlayer.playVideo(); // Bắt đầu phát lần đầu
                }, 100);
            } catch (e) {
                console.error('[SOUND] Lỗi phát âm thanh:', e);
            }
        }

        // Tạo thanh điều hướng
        function createNavigationBar() {
            const navBar = document.getElementById('navigation-bar');
            navBar.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = tab.name;
                btn.onclick = () => loadTab(index);
                navBar.appendChild(btn);
            });
            
            updateNavigationButtons();
        }

        // Cập nhật trạng thái các nút
        function updateNavigationButtons() {
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach((btn, index) => {
                if (index === currentTabIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function loadTab(index) {
            if (index < 0 || index >= tabs.length) {
                index = 0; // Quay về tab đầu tiên
            }
            currentTabIndex = index;
            
            const tab = tabs[currentTabIndex];
            const frame = document.getElementById('display-frame');
            
            console.log(`[TAB SWITCH] Đang chuyển sang: ${tab.name}`);
            
            // Phát âm thanh chuyển tab 4 lần
            if (typeof YT !== 'undefined' && YT.Player) {
                playTabSwitchSound();
            } else {
                // Nếu API chưa sẵn sàng, đợi một chút rồi thử lại
                setTimeout(() => {
                    if (typeof YT !== 'undefined' && YT.Player) {
                        playTabSwitchSound();
                    }
                }, 500);
            }
            
            frame.src = tab.file;
            
            // Cập nhật trạng thái nút
            updateNavigationButtons();

            // Xóa timer cũ nếu có
            if (tabTimer) {
                clearTimeout(tabTimer);
            }

            // Tính thời gian cho tab hiện tại
            let duration = tab.duration;
            
            // Nếu là "Vinh danh top 3", tính toán thời gian dựa trên số người
            if (tab.name === 'Vinh danh top 3' && duration === null) {
                try {
                    const honorsDataStr = localStorage.getItem('vinhDanhTop3');
                    if (honorsDataStr) {
                        const honorsData = JSON.parse(honorsDataStr);
                        const numPeople = honorsData.length || 6; // Mặc định 6 người (3 Sale + 3 MKT)
                        duration = numPeople * 30000; // Mỗi người 30 giây
                        console.log(`[VINH DANH] Có ${numPeople} người, thời gian: ${duration/1000} giây`);
                    } else {
                        duration = 180000; // Mặc định 3 phút (6 người * 30s) nếu không có data
                    }
                } catch (e) {
                    console.error('Lỗi đọc dữ liệu vinh danh:', e);
                    duration = 180000; // Mặc định 3 phút
                }
            }

            // Đặt timer để chuyển sang tab tiếp theo
            if (duration) {
                tabTimer = setTimeout(() => {
                    loadTab(currentTabIndex + 1);
                }, duration);
                console.log(`[TIMER] Tab "${tab.name}" sẽ chuyển sau ${duration/1000} giây (${duration/60000} phút)`);
            }
        }

        // --- BỘ LỌC ---
        function createFilterBar() {
            const filterBar = document.getElementById('filter-bar');
            
            // Tạo HTML cho bộ lọc
            filterBar.innerHTML = `
                <div class="filter-group">
                    <label style="color: white; font-weight: 600; margin-right: 5px;">Loại:</label>
                    <select class="filter-select" id="period-type">
                        <option value="week">Theo Tuần</option>
                        <option value="month">Theo Tháng</option>
                    </select>
                </div>
                
                <div class="filter-group" id="week-filter-container">
                    <label style="color: white; font-weight: 600; margin-right: 5px;">Tuần:</label>
                    <select class="filter-select" id="period-value">
                        <option value="w1">Tuần 1 (28/12 - 3/1)</option>
                        <option value="w2">Tuần 2 (4/1 - 10/1)</option>
                        <option value="w3">Tuần 3 (11/1 - 17/1)</option>
                        <option value="w4">Tuần 4 (18/1 - 24/1)</option>
                        <option value="w5">Tuần 5 (25/1 - 31/1)</option>
                    </select>
                </div>
                
                <div class="filter-group" id="month-filter-container" style="display: none;">
                    <label style="color: white; font-weight: 600; margin-right: 5px;">Tháng:</label>
                    <select class="filter-select" id="filter-month">
                        <option value="1">Tháng 1</option>
                        <option value="2">Tháng 2</option>
                        <option value="3">Tháng 3</option>
                        <option value="4">Tháng 4</option>
                        <option value="5">Tháng 5</option>
                        <option value="6">Tháng 6</option>
                        <option value="7">Tháng 7</option>
                        <option value="8">Tháng 8</option>
                        <option value="9">Tháng 9</option>
                        <option value="10">Tháng 10</option>
                        <option value="11">Tháng 11</option>
                        <option value="12">Tháng 12</option>
                    </select>
                    <select class="filter-select" id="filter-year">
                        <!-- Sẽ được điền bằng JS -->
                    </select>
                </div>
            `;
            
            // Điền năm
            populateYears();
            
            // Cập nhật các option tuần với thời gian thực tế
            populateWeekOptions();
            
            // Load filter settings từ localStorage nếu có
            loadFilterSettings();
            
            // Thêm event listeners
            document.getElementById('period-type').addEventListener('change', function() {
                toggleFilterUI();
                saveFilterSettings();
                notifyFilterChange();
            });
            
            document.getElementById('period-value').addEventListener('change', function() {
                saveFilterSettings();
                notifyFilterChange();
            });
            
            document.getElementById('filter-month').addEventListener('change', function() {
                adjustYearForMonth();
                saveFilterSettings();
                notifyFilterChange();
            });
            
            document.getElementById('filter-year').addEventListener('change', function() {
                saveFilterSettings();
                notifyFilterChange();
            });
        }

        function populateYears() {
            const sel = document.getElementById('filter-year');
            if (!sel) return;
            const cy = new Date().getFullYear();
            sel.innerHTML = '';
            for (let y = cy - 1; y <= cy + 1; y++) {
                let opt = document.createElement('option');
                opt.value = y;
                opt.text = "Năm " + y;
                if (y === cy) opt.selected = true;
                sel.appendChild(opt);
            }
        }

        // Hàm helper: Tính tuần từ một ngày (bắt đầu thứ 2, kết thúc chủ nhật)
        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Chủ nhật, 1 = Thứ 2, ..., 6 = Thứ 7
            const diff = day === 0 ? -6 : 1 - day; // Tính số ngày cần trừ để về thứ 2
            const monday = new Date(d);
            monday.setDate(d.getDate() + diff);
            monday.setHours(0, 0, 0, 0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            return { start: monday, end: sunday };
        }

        // Cập nhật các option tuần với thời gian thực tế
        function populateWeekOptions() {
            const weekSelect = document.getElementById('period-value');
            if (!weekSelect) return;

            const weekRanges = [
                { id: 'w1', date: new Date(2025, 11, 29) }, // Thứ 2
                { id: 'w2', date: new Date(2026, 0, 5) }, // Thứ 2
                { id: 'w3', date: new Date(2026, 0, 12) }, // Thứ 2
                { id: 'w4', date: new Date(2026, 0, 19) }, // Thứ 2
                { id: 'w5', date: new Date(2026, 0, 26) } // Thứ 2
            ];

            weekSelect.innerHTML = ''; // Xóa các option cũ

            weekRanges.forEach(week => {
                const weekRange = getWeekRange(week.date);
                const startDay = weekRange.start.getDate();
                const startMonth = weekRange.start.getMonth() + 1;
                const endDay = weekRange.end.getDate();
                const endMonth = weekRange.end.getMonth() + 1;
                
                const opt = document.createElement('option');
                opt.value = week.id;
                opt.textContent = `Tuần ${week.id.replace('w', '')} (${startDay}/${startMonth} - ${endDay}/${endMonth})`;
                weekSelect.appendChild(opt);
            });
        }

        function getCurrentWeek() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            // Tính tuần hiện tại (bắt đầu từ thứ 2)
            const day = now.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            const monday = new Date(now);
            monday.setDate(now.getDate() + diff);
            monday.setHours(0, 0, 0, 0);
            
            // So sánh với các tuần đã định nghĩa
            const weekRanges = [
                { id: 'w1', date: new Date(2025, 11, 29) },
                { id: 'w2', date: new Date(2026, 0, 5) },
                { id: 'w3', date: new Date(2026, 0, 12) },
                { id: 'w4', date: new Date(2026, 0, 19) },
                { id: 'w5', date: new Date(2026, 0, 26) }
            ];
            
            for (let week of weekRanges) {
                const weekDate = new Date(week.date);
                weekDate.setHours(0, 0, 0, 0);
                const weekDay = weekDate.getDay();
                const weekDiff = weekDay === 0 ? -6 : 1 - weekDay;
                const weekMonday = new Date(weekDate);
                weekMonday.setDate(weekDate.getDate() + weekDiff);
                
                if (monday.getTime() === weekMonday.getTime()) {
                    return week.id;
                }
            }
            
            return 'w1'; // Mặc định
        }

        function toggleFilterUI() {
            const type = document.getElementById('period-type').value;
            const weekContainer = document.getElementById('week-filter-container');
            const monthContainer = document.getElementById('month-filter-container');
            
            if (weekContainer) {
                weekContainer.style.display = type === 'week' ? 'flex' : 'none';
            }
            if (monthContainer) {
                monthContainer.style.display = type === 'month' ? 'flex' : 'none';
            }
            
            if (type === 'month') {
                adjustYearForMonth();
            }
        }

        function adjustYearForMonth() {
            const selectedMonth = parseInt(document.getElementById('filter-month').value);
            const selectedYear = parseInt(document.getElementById('filter-year').value);
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();

            if (selectedMonth > currentMonth && selectedYear === currentYear) {
                document.getElementById('filter-year').value = currentYear - 1;
            }
        }

        function saveFilterSettings() {
            const type = document.getElementById('period-type').value;
            const weekValue = document.getElementById('period-value').value;
            const m = parseInt(document.getElementById('filter-month').value);
            const y = parseInt(document.getElementById('filter-year').value);
            
            const settings = {
                periodType: type,
                periodValue: weekValue,
                month: m,
                year: y
            };
            
            localStorage.setItem('filterSettings', JSON.stringify(settings));
            console.log('[FILTER] Đã lưu filter settings:', settings);
        }

        function loadFilterSettings() {
            try {
                const settingsStr = localStorage.getItem('filterSettings');
                if (settingsStr) {
                    const settings = JSON.parse(settingsStr);
                    
                    if (document.getElementById('period-type')) {
                        document.getElementById('period-type').value = settings.periodType || 'week';
                    }
                    if (document.getElementById('period-value')) {
                        document.getElementById('period-value').value = settings.periodValue || getCurrentWeek();
                    }
                    if (document.getElementById('filter-month')) {
                        document.getElementById('filter-month').value = settings.month || new Date().getMonth() + 1;
                    }
                    if (document.getElementById('filter-year')) {
                        document.getElementById('filter-year').value = settings.year || new Date().getFullYear();
                    }
                    
                    toggleFilterUI();
                    console.log('[FILTER] Đã load filter settings:', settings);
                } else {
                    // Mặc định - tự động set về tuần hiện tại
                    const currentDate = new Date();
                    const currentWeek = getCurrentWeek();
                    const currentMonth = currentDate.getMonth() + 1;
                    const currentYear = currentDate.getFullYear();
                    
                    if (document.getElementById('period-type')) {
                        document.getElementById('period-type').value = 'week';
                    }
                    if (document.getElementById('period-value')) {
                        document.getElementById('period-value').value = currentWeek;
                    }
                    if (document.getElementById('filter-month')) {
                        document.getElementById('filter-month').value = currentMonth;
                    }
                    if (document.getElementById('filter-year')) {
                        document.getElementById('filter-year').value = currentYear;
                    }
                    toggleFilterUI();
                    saveFilterSettings(); // Lưu vào localStorage
                    console.log(`[INDEX] Tự động set về tuần hiện tại: ${currentWeek}`);
                }
            } catch (e) {
                console.error('[FILTER] Lỗi load settings:', e);
            }
        }

        function notifyFilterChange() {
            // Gửi message đến iframe để cập nhật dữ liệu
            const frame = document.getElementById('display-frame');
            if (frame && frame.contentWindow) {
                try {
                    frame.contentWindow.postMessage({ type: 'filterChanged' }, '*');
                } catch (e) {
                    console.error('Lỗi gửi message đến iframe:', e);
                }
            }
        }

        // Khởi động
        createFilterBar();
        createNavigationBar();
        
        // Khởi tạo sound player nếu YouTube API đã sẵn sàng
        if (typeof YT !== 'undefined' && YT.Player) {
            initSoundPlayer();
        } else {
            // Đợi YouTube API load
            let checkAPI = setInterval(() => {
                if (typeof YT !== 'undefined' && YT.Player) {
                    initSoundPlayer();
                    clearInterval(checkAPI);
                }
            }, 100);
            // Timeout sau 5 giây
            setTimeout(() => clearInterval(checkAPI), 5000);
        }
        
        loadTab(0);

        // Xử lý lỗi iframe
        document.getElementById('display-frame').addEventListener('error', function(e) {
            console.error('Lỗi load iframe:', e);
            // Thử chuyển sang tab tiếp theo nếu có lỗi
            setTimeout(() => {
                loadTab(currentTabIndex + 1);
            }, 5000);
        });
    </script>
</body>
</html>